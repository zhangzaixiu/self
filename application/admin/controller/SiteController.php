<?phpnamespace app\admin\controller;use think\Cookie;use think\Db;use think\facade\Cache;use think\Request;class SiteController extends  BaseController{    /**     * @return array|\think\response\View     * 登录     */    public function login()    {        $this->view->engine->layout(false);        if(\think\facade\Request::isAjax()){            $data=input("request.",'','trim');            try {                $name=$data["name"];                $password=$data["password"];                $rember_me= isset($data["rember_me"]);                //校验用户登录信息                $vld = $this->validate($data, 'User.login');                if ($vld === true) {                    //开启事务                    Db::startTrans();                    //根据用户名查询到用户密码、id等信息                    $join = [                        ['user_role b',"a.roleId=b.id and  b.isDelete = 0","left"],                    ];                    $msg=findById("user",array("a.mobile"=>$name),"a.is_all_iqbt,a.id,a.password,a.iqbtId,a.etprsId,a.type,a.status,a.name,a.realname,a.mobile,a.roleId,b.menuIds","a.id",$join);                    if($msg['code'] == 0 || empty($msg['data'])){                        throw new \think\Exception("用户查询失败");                    }                    if($msg["data"]["status"]=='6018003'){                        throw new \think\Exception("当前用户已被冻结");                    }                    //修改最后登录时间                    $loginmsg=saveData("user",array("id"=>$msg["data"]["id"],'lastloginTime'=>time()),"用户登录");                    if(empty($loginmsg["data"])){                        throw new \think\Exception("修改登录时间错误");                    }                    if($rember_me){                        \cookie('mobile',$msg["data"]["mobile"],2592000);                        \app\common\helper\Cookie::setCookie('password',$password,2592000);                    }else{                        cookie('mobile', null);                        cookie('password', null);                    }                    //不把密码存储到session里                    unset($msg["data"]["password"]);                    //将 用户信息记录到session                    session('user',$msg["data"]);                    session('userId',$msg["data"]["id"]);                    session('iqbtId',$msg["data"]["iqbtId"]);                    //添加登录日志                    $logmsg=saveLog("6012001","用户登录",session("userId"),"User");                    if($logmsg["code"]==='0'){                        throw new \think\Exception("写入日志错误");                    }                    //事务提交                    Db::commit();                    //获取跳转到的页面。跳转到第一个菜单页面                    $jump = url('/admin/index/index');                    return array("code" => 1, "msg" =>'登录成功','data'=>$msg["data"],'url'=>$jump);                } else {                    throw new \think\Exception("校验失败：" . $vld);                }            } catch (\Exception $e) {                // 回滚事务                Db::rollback();                return array("code" => 0, "msg" =>$e->getMessage(),'data'=>[]);            }        }        return view('login',['mobile'=>Cache::get('mobile'),'password'=>\app\common\helper\Cookie::getCookie('password')]);    }    /**     * 退出     */    function logout()    {        \think\Session::clear();        $this->redirect(url('/admin/login/login'));    }}