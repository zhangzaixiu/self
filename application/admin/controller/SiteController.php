<?phpnamespace app\admin\controller;use app\admin\model\UserModel;use think\facade\Cache;use think\facade\Cookie;use think\facade\Session;class SiteController extends  BaseController{    /**     * @return array|\think\response\View     * 登录     */    public function login()    {        $this->view->engine->layout(false);        if(\think\facade\Request::isAjax()){            try {                $data=input("request.",'','trim');                $this->validate($data, 'User.login');                $user = UserModel::get(['mobile'=>$data['mobile']]);                if(empty($user)){                    throw new \think\Exception("用户不存在");                }                if($user->password!= md5(md5($data['password']))){                    throw new \think\Exception("密码错误");                }                if($user->status ==2){                    throw new \think\Exception("当前用户被冻结");                }                $user->login_times += 1;                $user->last_login_time= time();                $user->save();                if(isset($data['rember_me'])){                    \cookie('mobile',$user->mobile,2592000);                    \app\common\helper\Cookie::setCookie('password',$data['password'],2592000);                }else{                    cookie('mobile', null);                    cookie('password', null);                }                //不把密码存储到session里                unset($user->password);                //将用户信息记录到session                session('user',$user);                session('userId',$user->id);                //获取跳转到的页面。跳转到第一个菜单页面                $jump = url('/admin/index/index');                return array("success" => 1, "msg" =>'登录成功','data'=>$user,'url'=>$jump);            } catch (\Exception $e) {                return array("success" => 0, "msg" =>$e->getMessage(),'data'=>[]);            }        }        return view('login',['mobile'=>Cookie::get('mobile'),'password'=>\app\common\helper\Cookie::getCookie('password')]);    }    /**     *退出     */    function logout()    {       Session::clear();       $this->redirect(url('/admin/site/login'));    }    /**     * 忘记密码     * @return array|\think\response\Json|\think\response\View     */    function forget(){        if(\think\facade\Request::isPost()){            try {                $postData = input('',null,'trim');                $this->validate($postData, 'user.forget');                $user = UserModel::get(['mobile'=>$postData['mobile']]);                if(empty($user)){                    throw new \think\Exception("用户查询失败");                }                if($user->status ==2){                    throw new \think\Exception("当前用户被冻结");                }                $validate_code = SendCodeController::checkMobileCode($postData['mobile'],$postData['code']);                if($validate_code['code'] == 0){                    throw new \think\Exception ($validate_code['msg']);                }                $postData['password'] = md5(md5($postData['password']));                if(!$user->allowField(true)->force()->save($postData)){                    throw new \think\Exception('密码修改失败');                }                Cache::rm('sms_code_'.$postData['mobile']);                return json(array('success'=>1,'msg'=>'修改成功','url'=>url('admin/site/logout')));            }catch (\Exception $e){                return array('success'=>0,'msg'=>$e->getMessage());            }        }        return view();    }}